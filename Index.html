<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TurboPortuguÃªs â€” v3</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#009739"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  :root{
    --green:#009739; --gold:#FFCC29; --blue:#002776; --white:#ffffff;
    --bg:#011335; --card:#042052; --ink:#f2f7ff; --muted:#b6c4e6; --btn:#06306f;
    --good:#1ec28b; --warn:#ffd166; --bad:#ef476f; --easy:#1f9bf0;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,#00143a 0%, #011335 60%, #001632 100%);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;height:100%}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,20,58,.95) 0%, rgba(0,20,58,.6) 90%, transparent);backdrop-filter:blur(8px);padding:14px;border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
  .brand{display:flex;align-items:center;gap:10px}
  .badge{background:var(--green);color:#032b11;padding:3px 8px;border-radius:999px;font-weight:800}
  .wrap{padding:14px;max-width:1020px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg, rgba(0,39,118,.25), rgba(0,39,118,.12));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{background:linear-gradient(180deg, var(--gold), #e2b81f);color:#102100;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  button.alt{background:linear-gradient(180deg, #0a4bc2, #063a97);color:#eaf1ff}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--ink)}
  button:active{transform:translateY(1px)}
  .pt{font-size:26px;font-weight:800}
  .ipa{color:var(--muted);font-family:ui-monospace, Menlo, Consolas, monospace}
  .en{color:#e8efff}
  .big{font-size:32px;font-weight:900;text-align:center;margin:10px 0}
  .center{text-align:center}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .section-title{font-size:14px;color:var(--gold);text-transform:uppercase;letter-spacing:.14em}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .kpi .card{padding:12px}
  .kpi .num{font-size:22px;font-weight:900}
  .tag{background:rgba(0,151,57,.22);border:1px solid rgba(0,151,57,.5);padding:2px 8px;border-radius:999px;margin-right:6px;color:#b7f5d7}
  .ratebar{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .again{background:var(--bad)} .hard{background:#f7b801;color:#1a1a1a} .good{background:var(--good)} .easy{background:var(--easy)}
  .hidden{display:none}
  /* bottom tabs */
  .tabs{position:sticky;bottom:0;left:0;right:0;background:linear-gradient(180deg, rgba(0,20,58,.1), rgba(0,20,58,.6));backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-around;padding:10px 8px;z-index:20}
  .tab{display:flex;flex-direction:column;align-items:center;gap:4px;color:#dfe9ff;opacity:.7}
  .tab.active{opacity:1;color:#fff}
  .tab .dot{width:6px;height:6px;border-radius:50%;background:transparent}
  .tab.active .dot{background:var(--gold)}
  .view{display:none} .view.active{display:block}
  .xpbar{height:12px;background:#0b2a67;border-radius:999px;overflow:hidden}
  .xpbar > div{height:100%;background:linear-gradient(90deg, var(--green), #00d77a);width:0%}
  .map{height:120px;background:linear-gradient(180deg, rgba(0,151,57,.18), rgba(0,151,57,.05));border:1px dashed rgba(0,151,57,.4);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#a3f5c9}
  .setting{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
  input[type="text"], select{background:#061b47;border:1px solid rgba(255,255,255,.16);color:var(--ink);border-radius:10px;padding:8px 10px;min-width:160px}
  .small{font-size:12px}
</style>
</head>
<body>
<header class="wrap">
  <div class="brand">
    <div style="font-weight:900;font-size:20px">TurboPortuguÃªs</div>
    <span class="badge">v3</span>
  </div>
  <div class="muted" style="margin-top:4px">Duolingo-style tabs â€¢ Brazil theme â€¢ SRS â€¢ Missions â€¢ Pronunciation â€¢ AI-ready</div>
</header>

<div class="wrap">
  <!-- HOME VIEW -->
  <div id="view-home" class="view active">
    <div class="grid">
      <section class="card">
        <div class="section-title">Today</div>
        <div class="kpi">
          <div class="card"><div class="muted small">Due Reviews</div><div id="kpi-due" class="num">0</div></div>
          <div class="card"><div class="muted small">New Cards</div><div id="kpi-new" class="num">0</div></div>
          <div class="card"><div class="muted small">Streak</div><div id="kpi-streak" class="num">0</div></div>
          <div class="card"><div class="muted small">Retention</div><div id="kpi-ret" class="num">â€“</div></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="quick-review">Start Review</button>
          <button class="alt" id="quick-lesson">New Lesson</button>
          <button class="ghost" id="quick-mission">Mission</button>
        </div>
      </section>

      <section class="card">
        <div class="section-title">Progress</div>
        <div class="row" style="align-items:center">
          <div style="flex:1">
            <div class="muted small">XP</div>
            <div class="xpbar"><div id="xpbar"></div></div>
            <div class="muted small" id="xptext" style="margin-top:6px">0 / 100</div>
          </div>
          <div style="flex:1">
            <div class="muted small">Brazil Map</div>
            <div class="map">âš‘ Unlock states as you learn</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">Daily Easy Win</div>
        <div class="row">
          <div id="easywin" class="muted">Repeat â€œOi! Tudo bem?â€ 3Ã— out loud and tap Complete.</div>
          <button class="alt" id="btn-easywin">Complete (+10 XP)</button>
        </div>
      </section>
    </div>
  </div>

  <!-- LEARN VIEW -->
  <div id="view-learn" class="view">
    <section class="card">
      <div class="section-title">Decks</div>
      <div class="row">
        <select id="deck-select">
          <option value="core">Core</option>
          <option value="restaurant">Restaurant</option>
          <option value="rideshare">Rideshare</option>
          <option value="emergency">Emergency</option>
        </select>
        <button id="btn-start">Start Reviews</button>
        <button id="btn-new">Learn New (5)</button>
      </div>
    </section>

    <section class="card" id="review-panel">
      <div class="section-title">Spaced Repetition</div>
      <div id="review-empty" class="center muted">No cards queued. Hit â€œStart Reviewsâ€ or â€œLearn Newâ€.</div>
      <div id="review-ui" class="hidden">
        <div id="card-idx" class="muted right small"></div>
        <div class="big" id="pt"></div>
        <div class="center ipa" id="ipa"></div>
        <div class="center muted" id="tags"></div>
        <div class="row center" style="justify-content:center;margin:14px 0">
          <button id="btn-tts" class="alt">ğŸ”Š Listen</button>
          <button id="btn-reveal">Reveal</button>
          <button id="btn-record" class="ghost">ğŸ™ï¸ Shadow</button>
        </div>
        <div id="en" class="en center hidden"></div>
        <div class="ratebar hidden" id="ratebar">
          <button class="again" onclick="grade(0)">Again</button>
          <button class="hard" onclick="grade(3)">Hard</button>
          <button class="good" onclick="grade(4)">Good</button>
          <button class="easy" onclick="grade(5)">Easy</button>
        </div>
        <div id="rec-status" class="center muted small" style="margin-top:8px"></div>
      </div>
    </section>
  </div>

  <!-- PRACTICE VIEW -->
  <div id="view-practice" class="view">
    <section class="card">
      <div class="section-title">Pronunciation Coach</div>
      <div class="row">
        <select id="mp-select"></select>
        <button onclick="mpPlayA()">ğŸ”Š A</button>
        <button onclick="mpPlayB()">ğŸ”Š B</button>
        <button onclick="mpRandom()">Shuffle</button>
      </div>
      <div style="margin-top:8px">
        <div><span class="tag">A</span> <span id="mp-a" class="pt"></span> <span id="mp-a-en" class="muted small"></span></div>
        <div><span class="tag">B</span> <span id="mp-b" class="pt"></span> <span id="mp-b-en" class="muted small"></span></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btn-pronounce" class="alt">ğŸ™ï¸ Record & Score</button>
        <div id="score" class="muted">Score: â€“</div>
      </div>
      <div class="muted small">Tip: Say A five times, then B five times, then ABABAB. (AI phoneme scoring can be plugged in later.)</div>
    </section>
  </div>

  <!-- MISSIONS VIEW -->
  <div id="view-missions" class="view">
    <section class="card">
      <div class="section-title">Daily Mission</div>
      <div id="mission"></div>
      <div class="row" style="margin-top:8px">
        <button onclick="nextMission()">New Mission</button>
        <button onclick="speakMission()" class="alt">ğŸ”Š Speak Prompt</button>
      </div>
    </section>
  </div>

  <!-- PROFILE / SETTINGS VIEW -->
  <div id="view-profile" class="view">
    <section class="card">
      <div class="section-title">Settings</div>
      <div class="setting">
        <div>Daily Goal (minutes)</div>
        <input type="text" id="goal" value="15"/>
      </div>
      <div class="setting">
        <div>Voice Provider</div>
        <select id="voice-provider">
          <option value="system">System (pt-BR)</option>
          <option value="api-eleven">ElevenLabs (API Key)</option>
          <option value="api-azure">Azure Neural (API Key)</option>
        </select>
      </div>
      <div class="setting">
        <div>API Key</div>
        <input type="text" id="api-key" placeholder="Paste API key (optional)"/>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="save-settings">Save</button>
        <button class="ghost" id="btn-export">Export Progress</button>
      </div>
      <div id="install-hint" class="muted small" style="margin-top:6px"></div>
    </section>
  </div>
</div>

<!-- Bottom Tabs -->
<nav class="tabs">
  <div class="tab active" data-view="home">ğŸ <div class="small">Home</div><div class="dot"></div></div>
  <div class="tab" data-view="learn">ğŸ“š<div class="small">Learn</div><div class="dot"></div></div>
  <div class="tab" data-view="practice">ğŸ¤<div class="small">Practice</div><div class="dot"></div></div>
  <div class="tab" data-view="missions">ğŸ¯<div class="small">Missions</div><div class="dot"></div></div>
  <div class="tab" data-view="profile">ğŸ‘¤<div class="small">Profile</div><div class="dot"></div></div>
</nav>

<script>
// PWA install + SW
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; });
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }
(function showIOSHint(){
  const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  if(isiOS){ document.getElementById('install-hint').textContent = "On iPhone: open in Safari â†’ Share â†’ Add to Home Screen."; }
})();

// Tabs
const views = ["home","learn","practice","missions","profile"];
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const v = t.dataset.view;
  views.forEach(k=>document.getElementById('view-'+k).classList.remove('active'));
  document.getElementById('view-'+v).classList.add('active');
}));
document.getElementById('view-home').classList.add('active');

// Decks
const CORE = [
  {id:1, pt:"Oi! Tudo bem?", en:"Hi! How are you?", ipa:"oj Ëˆtudu báº½j", tags:["greeting"]},
  {id:2, pt:"Tudo bem, e vocÃª?", en:"Iâ€™m good, and you?", ipa:"Ëˆtudu báº½j i voËˆse", tags:["smalltalk"]},
  {id:3, pt:"Prazer em te conhecer.", en:"Nice to meet you.", ipa:"pÉ¾aËˆzeÉ¾ áº½j tÊƒi koÉ²eËˆseÉ¾", tags:["greeting"]},
  {id:4, pt:"VocÃª pode falar mais devagar?", en:"Can you speak more slowly?", ipa:"voËˆse ËˆpÉ”dÊ’i faËˆlaÉ¾ majÊƒ dÊ’evaËˆgaÉ¾", tags:["comprehension"]},
  {id:5, pt:"Pode repetir, por favor?", en:"Can you repeat, please?", ipa:"ËˆpÉ”dÊ’i ÊepiËˆtiÉ¾ poÉ¾ faËˆvoÉ¾", tags:["comprehension"]},
  {id:6, pt:"Que horas sÃ£o?", en:"What time is it?", ipa:"ki ËˆÉ”É¾És sÉÌƒw", tags:["time"]},
  {id:7, pt:"Onde fica o banheiro?", en:"Where is the bathroom?", ipa:"ËˆÃµdÊ’i ËˆfikÉ u bÉËˆÉ²eÉ¾u", tags:["travel"]},
  {id:8, pt:"Obrigado(a).", en:"Thank you.", ipa:"obÉ¾iËˆgadÊŠ / obÉ¾iËˆgadÉ", tags:["polite"]},
  {id:9, pt:"Beleza!", en:"Great! / Cool!", ipa:"beËˆlezÉ", tags:["slang"]},
  {id:10, pt:"Tudo certo.", en:"All good / Okay.", ipa:"Ëˆtudu ËˆsÉ›É¾tu", tags:["smalltalk"]}
];
const RESTAURANT = [
  {id:101, pt:"Eu queria um espresso, por favor.", en:"Iâ€™d like an espresso, please.", ipa:"ew keËˆÉ¾ijÉ Å© esËˆpÉ¾É›su poÉ¾ faËˆvoÉ¾", tags:["restaurant"]},
  {id:102, pt:"Tem pÃ£o de queijo?", en:"Do you have cheese bread?", ipa:"táº½ paw dÊ’i ËˆkeÊ’u", tags:["restaurant"]},
  {id:103, pt:"Sem gelo / Com gelo.", en:"No ice / With ice.", ipa:"sáº½ ËˆÊ’elu / kÃµ ËˆÊ’elu", tags:["restaurant"]},
  {id:104, pt:"Sem / Com aÃ§Ãºcar.", en:"Without / With sugar.", ipa:"sáº½ / kÃµ aËˆsukÉÉ¾", tags:["restaurant"]},
  {id:105, pt:"Pode ser no cartÃ£o?", en:"Can I pay by card?", ipa:"ËˆpÉ”dÊ’i seÉ¾ nu kaÉ¾ËˆtÉÌƒw", tags:["payment"]}
];
const RIDESHARE = [
  {id:201, pt:"Boa noite! VocÃª Ã© o(a) motorista?", en:"Good evening! Are you the driver?", ipa:"Ëˆboa ËˆnojtÊƒi voËˆse É› u moÌtoËˆÉ¾istÉ", tags:["rideshare"]},
  {id:202, pt:"Vamos para o endereÃ§o...", en:"Weâ€™re going to the address...", ipa:"ËˆvÉmuz ËˆpaÉ¾É u áº½deËˆÉ¾esu", tags:["rideshare"]},
  {id:203, pt:"Pode ligar o ar-condicionado?", en:"Can you turn on the AC?", ipa:"ËˆpÉ”dÊ’i liËˆgaÉ¾ u aÊ kÃµdÊ’isjÃµËˆnadu", tags:["rideshare"]},
  {id:204, pt:"Pode parar aqui, por favor.", en:"Please stop here.", ipa:"ËˆpÉ”dÊ’i paËˆÉ¾aÊ aËˆki poÉ¾ faËˆvoÉ¾", tags:["rideshare"]}
];
const EMERGENCY = [
  {id:301, pt:"Eu preciso de ajuda.", en:"I need help.", ipa:"Ëˆew pÉ¾eËˆzizu dÊ’i aËˆÊ’udÉ", tags:["emergency"]},
  {id:302, pt:"Chame a polÃ­cia, por favor.", en:"Call the police, please.", ipa:"ËˆÊƒÉmi a poËˆlisjÉ poÉ¾ faËˆvoÉ¾", tags:["emergency"]},
  {id:303, pt:"Estou passando mal.", en:"Iâ€™m feeling sick.", ipa:"isËˆtow paËˆsÉÌƒdu Ëˆmaw", tags:["health"]},
  {id:304, pt:"Onde fica o hospital mais perto?", en:"Where is the nearest hospital?", ipa:"ËˆÃµdÊ’i ËˆfikÉ u oÊƒpiËˆtaw majÊƒ ËˆpÉ›É¾tu", tags:["health"]}
];
const DECKS = { core: CORE, restaurant: RESTAURANT, rideshare: RIDESHARE, emergency: EMERGENCY };
// Minimal pairs
const MP = [
  {a:"pato", a_en:"duck", b:"bato", b_en:"I beat"},
  {a:"faca", a_en:"knife", b:"vaca", b_en:"cow"},
  {a:"casa", a_en:"house", b:"caÃ§a", b_en:"hunt"},
  {a:"tia", a_en:"aunt", b:"dia", b_en:"day"},
  {a:"pÃ£o", a_en:"bread (nasal)", b:"pau", b_en:"stick"},
  {a:"caro", a_en:"expensive", b:"carro", b_en:"car"}
];

// State
const LS_KEY = "turbo-pt-v3-state";
let state = loadState();
function loadState(){
  const s = localStorage.getItem(LS_KEY);
  if(s) return JSON.parse(s);
  const deckStates = {};
  Object.keys(DECKS).forEach(k=>{
    deckStates[k] = DECKS[k].map(x => ({id:x.id, ease:250, ivl:0, rep:0, due:Date.now(), lapses:0, stats:{seen:0, correct:0}}));
  });
  return { deckStates, deckKey:"core", streak:1, lastDay:dayStamp(), reviewsToday:0, correctToday:0, xp:0, goal:15, voiceProvider:"system", apiKey:"" };
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function dayStamp(){ return new Date().toISOString().slice(0,10); }

// KPIs + XP
function kpis(){
  const deck = state.deckStates[state.deckKey];
  const dueNow = deck.filter(c => c.due <= Date.now()).length;
  const newCount = deck.filter(c => c.rep===0).length;
  document.getElementById("kpi-due").textContent = dueNow;
  document.getElementById("kpi-new").textContent = newCount;
  document.getElementById("kpi-streak").textContent = state.streak;
  const ret = state.reviewsToday? Math.round(100*state.correctToday/state.reviewsToday)+'%' : 'â€“';
  document.getElementById("kpi-ret").textContent = ret;
  const cap = 100; const pct = Math.min(100, Math.round(100*state.xp/cap));
  document.getElementById("xpbar").style.width = pct + "%";
  document.getElementById("xptext").textContent = `${state.xp} / ${cap}`;
}
kpis();

// Goal + settings
document.getElementById('goal').value = state.goal;
document.getElementById('voice-provider').value = state.voiceProvider;
document.getElementById('api-key').value = state.apiKey;
document.getElementById('save-settings').addEventListener('click', ()=>{
  state.goal = parseInt(document.getElementById('goal').value||"15",10);
  state.voiceProvider = document.getElementById('voice-provider').value;
  state.apiKey = document.getElementById('api-key').value;
  save(); alert("Saved!");
});

// Easy win
document.getElementById('btn-easywin').addEventListener('click', ()=>{ state.xp += 10; save(); kpis(); document.getElementById('easywin').textContent = "Nice! +10 XP"; });

// Quick buttons
document.getElementById('quick-review').addEventListener('click', ()=>{ switchTab('learn'); startReviews(); });
document.getElementById('quick-lesson').addEventListener('click', ()=>{ switchTab('learn'); startNew(5); });
document.getElementById('quick-mission').addEventListener('click', ()=>{ switchTab('missions'); });

// Deck select
document.getElementById('deck-select').value = state.deckKey;
document.getElementById('deck-select').addEventListener('change', e=>{ state.deckKey = e.target.value; save(); kpis(); setReviewEmpty(true); });

// Review engine
let queue=[]; let current=null;
function buildQueue(n=20){ const d = state.deckStates[state.deckKey]; queue = d.filter(c=>c.due<=Date.now()).sort((a,b)=>a.due-b.due).slice(0,n); }
function buildNew(n=5){ const d = state.deckStates[state.deckKey]; queue = d.filter(c=>c.rep===0).slice(0,n); }
function startReviews(){ buildQueue(); renderCard(); }
function startNew(n){ buildNew(n); renderCard(); }
document.getElementById('btn-start').addEventListener('click', startReviews);
document.getElementById('btn-new').addEventListener('click', ()=>startNew(5));

function setReviewEmpty(show){ document.getElementById('review-empty').classList.toggle('hidden', !show); document.getElementById('review-ui').classList.toggle('hidden', show); }
function dataFor(id){ return DECKS[state.deckKey].find(x=>x.id===id); }
function idxFor(id){ return state.deckStates[state.deckKey].findIndex(x=>x.id===id); }
function renderCard(){
  if(queue.length===0){ setReviewEmpty(true); kpis(); return; }
  setReviewEmpty(false);
  current = queue[0];
  const d = dataFor(current.id);
  document.getElementById('card-idx').textContent = `${state.deckKey.toUpperCase()} â€¢ ${idxFor(current.id)+1}/${state.deckStates[state.deckKey].length}`;
  document.getElementById('pt').textContent = d.pt;
  document.getElementById('ipa').textContent = d.ipa||"";
  document.getElementById('tags').innerHTML = (d.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("");
  document.getElementById('en').textContent = d.en;
  document.getElementById('en').classList.add('hidden');
  document.getElementById('ratebar').classList.add('hidden');
  document.getElementById('rec-status').textContent = "";
}
document.getElementById('btn-reveal').addEventListener('click', ()=>{
  document.getElementById('en').classList.remove('hidden');
  document.getElementById('ratebar').classList.remove('hidden');
});
document.getElementById('btn-tts').addEventListener('click', ()=>{
  const d = dataFor(current.id); speak(d.pt, 'pt-BR');
});
// grading
function grade(q){
  const i = idxFor(current.id);
  const c = state.deckStates[state.deckKey][i];
  state.reviewsToday = (state.reviewsToday||0)+1;
  if(q>=3){ state.correctToday = (state.correctToday||0)+1; state.xp += (q===5?6:(q===4?4:2)); }
  const now = Date.now();
  if(q<3){
    c.lapses += 1; c.rep = Math.max(0,c.rep-1); c.ivl=0; c.due = now + 12*60*60*1000; c.ease = Math.max(130,(c.ease||250)-20);
  }else{
    c.rep += 1; c.ease = Math.max(130,(c.ease||250)+(q-3)*10);
    c.ivl = (c.ivl===0)? 24*60*60*1000 : Math.round(c.ivl*(c.ease/100));
    if(c.rep===1) c.ivl = 24*60*60*1000; if(c.rep===2) c.ivl = 3*24*60*1000*24;
    c.due = now + c.ivl;
  }
  save(); queue.shift(); renderCard(); kpis();
}

// TTS
function speak(text, lang='pt-BR'){
  if(state.voiceProvider==='system' || !state.apiKey){
    const u = new SpeechSynthesisUtterance(text); u.lang = lang; u.rate=1.0; speechSynthesis.speak(u); return;
  }
  // Placeholder for cloud TTS fetch; fall back to system if blocked
  const u = new SpeechSynthesisUtterance(text); u.lang = lang; speechSynthesis.speak(u);
}

// Recording
let mediaRecorder, chunks=[], recording=false;
async function toggleRecord(){
  if(recording){ mediaRecorder.stop(); recording=false; return; }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream); chunks=[];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = e => {
      const blob = new Blob(chunks,{type:'audio/webm'});
      const url = URL.createObjectURL(blob);
      document.getElementById('rec-status').innerHTML = `Recorded. <a class="muted" href="${url}" target="_blank">Play</a>`;
    };
    mediaRecorder.start(); recording=true;
    document.getElementById('rec-status').textContent = "Recordingâ€¦ tap again to stop.";
    setTimeout(()=>{ if(recording){ mediaRecorder.stop(); recording=false; }}, 8000);
  }catch(err){
    document.getElementById('rec-status').textContent = "Mic requires HTTPS + permission.";
  }
}
document.getElementById('btn-record').addEventListener('click', toggleRecord);

// Minimal pairs UI + mock scoring
let mpIdx=0;
function mpRender(){
  const x = MP[mpIdx];
  document.getElementById('mp-a').textContent = x.a; document.getElementById('mp-a-en').textContent = " â€“ " + x.a_en;
  document.getElementById('mp-b').textContent = x.b; document.getElementById('mp-b-en').textContent = " â€“ " + x.b_en;
  const sel = document.getElementById('mp-select'); sel.innerHTML="";
  MP.forEach((it,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${i+1}. ${it.a} / ${it.b}`; if(i===mpIdx) o.selected=true; sel.appendChild(o); });
}
function mpPlayA(){ speak(MP[mpIdx].a,'pt-BR'); }
function mpPlayB(){ speak(MP[mpIdx].b,'pt-BR'); }
function mpRandom(){ mpIdx = Math.floor(Math.random()*MP.length); mpRender(); }
document.getElementById('mp-select').addEventListener('change', e=>{ mpIdx = +e.target.value; mpRender(); });
mpRender();

// Rough similarity scoring (placeholder for AI phoneme scoring)
document.getElementById('btn-pronounce').addEventListener('click', async ()=>{
  state.xp += 5; save(); kpis();
  document.getElementById('score').textContent = "Score: practice +5 XP (enable AI scoring in a cloud build)";
});

// Missions
const MISSIONS = [
  "No cafÃ©: peÃ§a um espresso e um pÃ£o de queijo, e pergunte o preÃ§o.",
  "No Uber: cumprimente o motorista e diga para onde vocÃª vai.",
  "No restaurante: peÃ§a Ã¡gua sem gelo e a conta no final.",
  "No hotel: faÃ§a check-in e confirme o horÃ¡rio do cafÃ© da manhÃ£.",
  "Compras: pergunte se aceita cartÃ£o e se tem outra cor/tamanho."
];
function currentMission(){ return localStorage.getItem("mission") || MISSIONS[0]; }
function setMission(m){ localStorage.setItem("mission", m); document.getElementById("mission").textContent = m; }
function nextMission(){ const m = MISSIONS[Math.floor(Math.random()*MISSIONS.length)]; setMission(m); }
function speakMission(){ speak(currentMission(),'pt-BR'); }
setMission(currentMission());

// Export
document.getElementById('btn-export').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob); const a = document.createElement("a");
  a.href=url; a.download="turbo-pt-progress-v3.json"; a.click();
});

// Helpers
function switchTab(name){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelector(`.tab[data-view="${name}"]`).classList.add('active');
  views.forEach(k=>document.getElementById('view-'+k).classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
}
</script>
</body>
</html>
